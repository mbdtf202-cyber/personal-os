generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Training System Enums
enum TrainingDomain {
  PRODUCT        // 产品设计
  PROJECT_MGMT   // 项目管理
  FRONTEND       // 前端开发
  BACKEND        // 后端开发
  TESTING        // 测试
  DEVOPS         // 运维/DevOps
  AI_COLLAB      // AI 协作
}

enum TrainingSessionType {
  DESIGN         // 设计
  CODING         // 编码
  CODE_REVIEW    // 代码审查
  DEBUGGING      // 调试排错
  REFACTOR       // 重构
  READING        // 阅读学习
  DEPLOYMENT     // 部署
  REFLECTION     // 复盘总结
  OTHER          // 其他
}

enum TrainingPlanStatus {
  DRAFT          // 草稿
  ACTIVE         // 进行中
  COMPLETED      // 已完成
  PAUSED         // 已暂停
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  avatar    String?
  timezone  String   @default("Asia/Shanghai")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  healthLogs        HealthDailyLog[]
  habits            Habit[]
  posts             Post[]
  socialPosts       SocialPost[]
  trades            Trade[]
  tradingSummaries  TradingDailySummary[]
  projects          Project[]
  bookmarks         Bookmark[]
  newsSources       NewsSource[]
  trainingPlans     TrainingPlan[]
  trainingSessions  TrainingSession[]
  trainingReviews   TrainingWeeklyReview[]
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  type      String
  createdAt DateTime @default(now())

  posts       Post[]
  socialPosts SocialPost[]
  trades      Trade[]
  projects    Project[]
  bookmarks   Bookmark[]
}

model HealthDailyLog {
  id              String    @id @default(cuid())
  userId          String
  date            DateTime
  sleepStart      DateTime?
  sleepEnd        DateTime?
  sleepHours      Float?
  exerciseMinutes Int?
  exerciseType    String?
  moodScore       Int?
  energyScore     Int?
  stressLevel     Int?
  remark          String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model Habit {
  id                   String   @id @default(cuid())
  userId               String
  name                 String
  description          String?
  frequencyType        String
  targetTimesPerPeriod Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  checkins HabitCheckin[]

  @@index([userId])
}

model HabitCheckin {
  id        String   @id @default(cuid())
  habitId   String
  date      DateTime
  done      Boolean  @default(true)
  createdAt DateTime @default(now())

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@index([habitId, date])
}

model Post {
  id              String   @id @default(cuid())
  userId          String
  title           String
  contentMarkdown String?
  category        String
  status          String   @default("DRAFT")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags             Tag[]
  links            PostLink[]
  trainingSessions TrainingSession[]

  @@index([userId, status])
  @@index([category])
}

model PostLink {
  id         String   @id @default(cuid())
  postId     String
  linkedType String
  linkedId   String
  createdAt  DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([linkedType, linkedId])
}

model NewsSource {
  id            String   @id @default(cuid())
  userId        String
  name          String
  type          String
  url           String
  fetchStrategy String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items NewsItem[]

  @@unique([userId, name])
  @@index([userId, type])
}

model NewsItem {
  id           String   @id @default(cuid())
  sourceId     String
  title        String
  url          String
  summary      String?
  previewImage String?
  siteName     String?
  domain       String?
  faviconUrl   String?
  type         String   @default("article")
  category     String?
  publishedAt  DateTime
  fetchedAt    DateTime @default(now())
  isRead       Boolean  @default(false)
  isFavorited  Boolean  @default(false)

  source NewsSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId, publishedAt])
  @@index([isRead, isFavorited])
  @@index([type])
}

model SocialPost {
  id                 String   @id @default(cuid())
  userId             String
  platform           String
  title              String
  contentText        String
  status             String   @default("IDEA")
  plannedPublishTime DateTime?
  actualPublishTime  DateTime?
  url                String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags  Tag[]
  stats SocialPostStats[]

  @@index([userId, status])
  @@index([platform, status])
}

model SocialPostStats {
  id           String   @id @default(cuid())
  socialPostId String
  snapshotTime DateTime @default(now())
  views        Int      @default(0)
  likes        Int      @default(0)
  comments     Int      @default(0)
  shares       Int      @default(0)
  collects     Int      @default(0)

  socialPost SocialPost @relation(fields: [socialPostId], references: [id], onDelete: Cascade)

  @@index([socialPostId, snapshotTime])
}

model Trade {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  market      String
  symbol      String
  direction   String
  entryPrice  Float
  exitPrice   Float
  quantity    Float
  pnl         Float
  fees        Float
  strategyTag String?
  reasonOpen  String?
  reasonClose String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags Tag[]

  @@index([userId, date])
  @@index([market, symbol])
}

model TradingDailySummary {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime
  totalPnl        Float
  mistakes        String?
  whatWentWell    String?
  planForTomorrow String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model Project {
  id               String    @id @default(cuid())
  userId           String
  title            String
  description      String?
  longDescription  String?
  status           String    @default("IDEA")
  techStack        String?
  githubUrl        String?
  liveUrl          String?
  imageUrl         String?
  previewImage     String?
  stars            Int?
  language         String?
  startDate        DateTime?
  endDate          DateTime?
  isPublic         Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags             Tag[]
  trainingSessions TrainingSession[]

  @@index([userId, status])
  @@index([isPublic])
}

model Bookmark {
  id            String    @id @default(cuid())
  userId        String
  title         String
  url           String
  description   String?
  siteName      String?
  domain        String?
  faviconUrl    String?
  imageUrl      String?
  type          String    @default("other")
  category      String
  status        String    @default("TO_READ")
  lastVisitedAt DateTime?
  visitCount    Int       @default(0)
  isFavorite    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags Tag[]

  @@index([userId, category])
  @@index([status, isFavorite])
  @@index([userId, type])
}

// Training System Models
model TrainingPlan {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  domains     String              // JSON array of TrainingDomain
  
  startDate   DateTime?
  endDate     DateTime?
  weeks       Int?
  status      TrainingPlanStatus  @default(DRAFT)
  
  targetHoursPerWeek Int?
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  sessions      TrainingSession[]
  weeklyReviews TrainingWeeklyReview[]
  
  @@index([userId, status])
}

model TrainingSession {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planId      String?
  plan        TrainingPlan?       @relation(fields: [planId], references: [id], onDelete: SetNull)
  
  date        DateTime
  title       String
  type        TrainingSessionType
  durationMin Int?
  
  domains     String              // JSON array of TrainingDomain
  skillTags   String              // JSON array of strings
  
  description String?
  
  projectId   String?
  project     Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  blogPostId  String?
  blogPost    Post?               @relation(fields: [blogPostId], references: [id], onDelete: SetNull)
  
  aiInvolved  Boolean             @default(false)
  aiTools     String              // JSON array of strings
  aiNotes     String?
  
  outcomeScore Int?
  notesMd      String?
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  @@index([userId, date])
  @@index([planId])
  @@index([projectId])
  @@index([type])
}

model TrainingWeeklyReview {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planId      String?
  plan        TrainingPlan?  @relation(fields: [planId], references: [id], onDelete: SetNull)
  
  weekIndex   Int
  startDate   DateTime
  endDate     DateTime
  
  summaryMd   String
  lessonsMd   String
  nextFocusMd String
  
  metricsJson Json?
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@unique([planId, weekIndex])
  @@index([userId, startDate])
}
