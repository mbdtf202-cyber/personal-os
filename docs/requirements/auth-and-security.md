# 认证与权限强化需求文档

## 背景
Personal OS 从单用户原型演进为面向多用户的 SaaS，需要确保每一个接口都基于真实的会话身份执行，并能够区分普通用户与管理员。现有代码中部分 API 仍沿用默认用户 ID，且缺少敏感操作的权限保护，也没有文档化此次安全升级的范围。该文档用于描述认证/授权优化的目标、范围与验收标准，为团队实施与回归测试提供依据。

## 总体目标
1. **基于 Session 的强鉴权** —— 所有需要用户身份的页面与 API 必须依赖真实登录态，未登录时统一返回 401 或跳转登录页。
2. **角色与权限控制** —— 为用户模型新增 `role` 字段，支持 `USER` 与 `ADMIN`，并确保仅管理员能执行平台级操作（如缓存清理）。
3. **API 访问隔离** —— 每个请求都必须验证资源归属，禁止跨用户读写（例如书签访问计数）。
4. **可追溯需求** —— 为后续迭代提供清晰的需求描述、业务背景与验收方式。

## 功能需求
### 1. 会话鉴权强化
- 登录成功后创建 Session，所有服务端页面需调用 `requirePageAuth()` 获取当前用户；未登录时重定向到 `/login`。
- API 路由使用 `requireAuth()`/`requireApiAuth()`；无 Session 时抛出 `UnauthorizedError` 并返回 401 JSON。
- 公共工具 `handleApiError` 能识别 `UnauthorizedError`，确保各 API 无需重复写 401 逻辑。

### 2. 角色体系
- `prisma.schema` 中新增 `Role` 枚举与 `User.role` 字段，默认 `USER`。
- 种子数据与脚本创建的默认账户设置为 `ADMIN`，保证至少存在一个管理员。
- 新增 `requireAdmin()`，在缓存清理等敏感 API 中调用；无权限时返回 403/401。

### 3. 资源访问隔离
- 所有依赖用户 ID 的查询需来自当前登录用户，禁止硬编码 `local-user`。
- 书签访问计数接口 `PATCH /api/bookmarks/[id]/visit` 必须校验书签所属用户，否则返回 403。
- Workflow API、Dashboard 数据等接口均需改为使用当前用户的 ID。

### 4. 文档与可维护性
- README 增加指向本需求文档的入口，方便开发/QA 查阅。
- 文档需明确背景、目标、功能点与验收标准，以便未来扩展更多安全策略。

## 非功能性需求
- 认证失败时响应必须在 50ms 内返回（无需访问数据库的场景）。
- 所有新增逻辑需具备类型安全（TypeScript 校验通过），并与现有测试体系兼容。

## 验收标准
1. 未登录访问任一受保护页面跳转登录页，访问受保护 API 得到 401 JSON。
2. 使用普通用户身份调用 `/api/cache/clear`、书签访问 API 等敏感接口会得到 403/401。
3. `Role` 字段在数据库中可见，`prisma/seed.ts`、`scripts/db-init.ts` 均能创建管理员。
4. README 可找到本需求文档链接，内容涵盖背景、目标、功能需求、验收方式。
5. Vitest、TypeScript、Prisma Client 生成命令可顺利执行。
